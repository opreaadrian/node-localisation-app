/* globals google */
// Extra ; in order to prevent concatenation errors when combining with third party plugins
;(function(window, document, google, undefined) {

  'use strict';

  /** Check for geolocation support in an optimal manner*/
  var hasGeolocation = 'geolocation' in window.navigator;

  /** Return early and save some extra calls if geolocation API is unsupported */
  if (!hasGeolocation) {

    throw new Error('Operation not supported: geolocation unavailable.');

  }

  navigator.geolocation.getCurrentPosition(function(position) {

    initializeMap(position.coords);

  });

  function _handleMapMouseDown(evt) {
    evt.target.addEventListener('mousemove', _handleMapMouseMove, false);
    evt.target.addEventListener('mouseup', _handleMapMouseUp, false);
  }

  function _handleMapMouseMove(evt) {
    document.querySelector('.login-panel').classList.add('translucent');
  }

  function _handleMapMouseUp(evt) {
    document.querySelector('.login-panel').classList.remove('translucent');
    evt.target.removeEventListener('mousemove', _handleMapMouseMove);
  }
  /**
   * @method initializeMap
   *
   * @description Initializes the google map constructor with the user's current position
   *
   * @param {object} coords The coordinates object, containing the user's position specified in
   * terms of latitude / longitude -- obtained from HTML5 geolocation API
   */
  function initializeMap(coords) {
    var mapOptions,
      mapCanvas,
      map;

    mapOptions = {
      zoom: 17,
      center: new google.maps.LatLng(coords.latitude, coords.longitude),
      /**
       * HACK: This is here for testing purposes and should be added conditionally based on the page
       * where the map is actually loaded (currently added for "index" page)
       */
      disableDefaultUI: false,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    mapCanvas = document.querySelector('.map-canvas');

    mapCanvas.addEventListener('mousedown', _handleMapMouseDown, false);

    map = new google.maps.Map(mapCanvas, mapOptions);

    initializeInfoPanel(map, coords);
  }

  /**
   * @method initializeInfoPanel
   *
   * @description Initializes the info panel containing details about the user's position.
   *
   * @param {object} map The map object generated by initializeMap
   * @param {object} coords The coordinates object, specifying the current position of our user
   */
  function initializeInfoPanel(map, coords) {
    var infoWindow,
      pos = null,
      marker = null;

    pos = new google.maps.LatLng(coords.latitude, coords.longitude);


    marker = new google.maps.Marker({
      map: map,
      position: pos,
      title: 'You are here'
    });

    infoWindow = new google.maps.InfoWindow({
      content:
        (window.userProfileImage ? '<div><img class="profile-image img-thumbnail img-circle" src="' + window.userProfileImage +'"></div>' : '') +
        '<strong>Latitude: </strong>' +
        coords.latitude +
        '<br> <strong>Longitude: </strong> ' +
        coords.longitude +
        '<br><br>' +
        '<button class="more-info btn btn-info" data-toggle="modal" data-target="#myModal">Detailed info</button>',
      maxWidth: 200
    });

    infoWindow.open(marker.get('map'), marker);

    google.maps.event.addListener(marker, 'click', function() {
      infoWindow.open(marker.get('map'), marker);
    });

    map.setCenter(pos);
  }

})(window, document, google);
